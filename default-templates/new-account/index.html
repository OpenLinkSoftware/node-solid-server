<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Set content in the next line to false if you do not want your homepage to be automatically updated whenever a new version becomes available. -->
  <meta name="solid-allow-automatic-updates" content="true">
  <title>Personal Data Space (or POD) {{#if name}} of {{name}} {{/if}}</title>
  <link rel="stylesheet" href="/common/css/bootstrap.min.css">
  <link rel="stylesheet" href="/common/css/solid.css">

  <style>
    .session-action {
      margin-right: 15px;
    }
  </style>

  <script src="common/js/jquery.min.js"></script>
  <script src="common/js/bootstrap.min.js"></script>
  <script src="common/js/forge.min.js"></script>

</head>
<body>
<div class="container">
  <nav class="navbar navbar-default">
    <div class="container-fluid">
      <div class="navbar-header">
        <a href="/" class="navbar-brand">Personal Data Space (POD)</a>
      </div>
      <div class="nav navbar-right navbar-form">
        <a id="logged-href" href="" title="" style="display:none">
          <span class="glyphicon glyphicon-user"></span>
        </a>
        <span>&nbsp&nbsp</span>
        <button id="login"  type="button" class="hidden btn btn-default btn-success">Log in</button>
        <button id="logout" type="button" class="hidden btn btn-danger">Log out</button>
      </div>
    </div>
  </nav>

  <p class="lead">
    <span>
      This is a public homepage of <a href="{{webId}}">{{#if name}} {{name}} {{/if}}</a>
    </span>
  </p>

{{#if tlsCertWebid}}
  <section>
    <div class="list-group">
      <p class="lead">
        If you want to make use of the WebID-TLS+Delegation authentication protocol, add the following RDF statement to your Delegate's WebID-Profile Document or click "Update Delegator WebID-Profile Doc" button to attempt this action right now, assuming you are logged in using a WebID that Read+Write privileges on the target WebID-Profile document.
        <pre>
&lt;{{tlsCertWebid}}&gt; &lt;http://www.openlinksw.com/schemas/cert#onBehalfOf&gt; &lt;{{webId}}&gt; .
        </pre>
        <span>
          <input id="load_btn" class="btn btn-primary" value=" Update Delegator WebID-Profile Doc " type="button">
        </span>
      </p>
    </div>  
  </section>
{{/if}}
  
  <section>
    <h1>Data</h1>
    <div class="list-group">
      <a href="/profile/card" target="_blank" class="list-group-item">
        <span class="lead">Profile</span>
        <span class="badge">public</span>
      </a>
      <a href="/inbox/" target="_blank" class="list-group-item">
        <span class="lead">Inbox</span>
        <span class="badge">private</span>
      </a>
      <a href="/public/" target="_blank" class="list-group-item">
        <span class="lead">Public Folder</span>
        <span class="badge">public</span>
      </a>
      <a href="/private/" target="_blank" class="list-group-item">
        <span class="lead">Private Folder</span>
        <span class="badge">private</span>
      </a>
    </div>
  </section>
  
  <section>
    <h1>Apps</h1>
    <div class="list-group">
      <a href="/common/plume/" target="_blank" class="list-group-item">
        <span class="lead">Plume blog</span>
      </a>
      <a href="https://dokie.li/" target="_blank" class="list-group-item">
        <span class="lead">Dokieli</span>
      </a>
      <a href="https://github.com/solid/userguide" target="_blank" class="list-group-item">
        <span class="lead">Getting started with Solid and Data Browser</span>
      </a>
    </div>
  </section>

  <section class="hidden" id="accountSettings">
    <h1>Account settings</h1>
    <div class="list-group">
<!--
      <div id="update_profile" class="list-group-item">
-->
      <div class="list-group-item">
        <button type="button" class="btn" id="update_cert">Update Certificate</button>
      </div>
      <div class="list-group-item">
        <button type="button" class="btn" id="create-csr">Create Cert. Signature Request</button>
      </div>
      <a href="/account/delete/" class="list-group-item">
        <span class="lead">Delete account</span>
      </a>
    </div>
  </section>
  
<!-- Modal -->
<div class="modal fade" id="certModal" tabindex="-1" role="dialog" aria-labelledby="certModalLabel" aria-hidden="true">
  <div class="modal-dialog" style="width:500px" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
        <h4 class="modal-title">Create and register certificate</h4>
      </div>
      <div class="modal-body">
      
        <div class="accordion" id="accordion-cert">
          <div class="card">
            <div class="card-header" id="headingOne">
              <h5 class="mb-0">
                <button class="btn btn-link collapsed" type="button" data-toggle="collapse" data-target="#collapseOne" aria-expanded="false" aria-controls="collapseOne">
                  Create Self-Signed Certificate
                </button>
              </h5>
            </div>
        
            <div id="collapseOne" class="collapse" aria-labelledby="headingOne" data-parent="#accordion-cert">
              <div class="card-body">
                <div class="row">
                  <div class="col-md-12">
                    <label for="cert_name">Name:</label>
                    <input type="text" class="form-control" id="cert_name" value="{{name}}" />
                  </div>
                  <div class="col-md-12">&nbsp;</div>
                </div>
                <div class="row">
                  <div class="col-md-12">
                    <label for="cert_email">Email:</label>
                    <input type="email" class="form-control" id="cert_email" />
                  </div>
                  <div class="col-md-12">&nbsp;</div>
                </div>
                <div class="row">
                  <div class="col-md-12">
                    <label for="cert_Org">Organization:</label>
                    <input type="text" class="form-control" id="cert_Org" />
                  </div>
                  <div class="col-md-12">&nbsp;</div>
                </div>
                <div class="row">
                  <div class="col-md-12">
                    <label for="cert_OrgUnit">Organizational Unit:</label>
                    <input type="text" class="form-control" id="cert_OrgUnit" />
                  </div>
                  <div class="col-md-12">&nbsp;</div>
                </div>
                <div class="row">
                  <div class="col-md-12">
                    <label for="cert_City">City (Locality):</label>
                    <input type="text" class="form-control" id="cert_City" />
                  </div>
                  <div class="col-md-12">&nbsp;</div>
                </div>
                <div class="row">
                  <div class="col-md-12">
                    <label for="cert_State">State:</label>
                    <input type="text" class="form-control" id="cert_State" />
                  </div>
                  <div class="col-md-12">&nbsp;</div>
                </div>
                <div class="row">
                  <div class="col-md-4">
                    <label for="cert_Country">Country:</label>
                    <input type="text" class="form-control" id="cert_Country" />
                  </div>
                  <div class="col-md-12">&nbsp;</div>
                </div>
                <div class="row">
                  <div class="col-md-12">
                    <label id="lb_cert_pwd" for="cert_pwd">Password for PKCS12 Credentials Store:</label>
                    <input type="password" class="form-control" id="cert_pwd" />
                  </div>
                  <div class="col-md-12">&nbsp;</div>
                </div>
                <div class="row">
                  <div class="col-md-12">
                    <label for="cert_pwd1">Confirm Password:</label>
                    <input type="password" class="form-control" id="cert_pwd1" />
                  </div>
                  <div class="col-md-12">&nbsp;</div>
                </div>

                </p>
                <hr>
                <div class="row pull-right">
                  <div class="col-md-12">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    &nbsp;&nbsp;
                    <button id="gen-cert-btn" type="button" class="btn btn-primary pull-right">Continue</button>
                  </div>
                </div>
                </br>
             </div>
            </div>
          </div>

          <div class="card">
            <div class="card-header" id="headingTwo">
              <h5 class="mb-0">
                <button class="btn btn-link collapsed" type="button" data-toggle="collapse" data-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
                  Upload existed certificate
                </button>
              </h5>
            </div>
            <div id="collapseTwo" class="collapse" aria-labelledby="headingTwo" data-parent="#accordion-cert">
              <div class="card-body">
                <div class="row">
                  <div class="col-md-12">
                    <label for="cert-data">Certificate PEM data:</label>
                    <textarea class="form-control" id="cert-data" rows="10" style="white-space: nowrap;  overflow: auto;"></textarea>
                    </p>
                    <input type="file" id="cert-file-load" title="Load Certificate pem file">
                  </div>
                </div>
                </p>
                <hr>
                <div class="row pull-right">
                  <div class="col-md-12">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    &nbsp;&nbsp;
                    <button id="upload-existed-cert" type="button" class="btn btn-primary pull-right">Continue</button>
                  </div>
                </div>
                </br>
              </div>
            </div>
          </div>
        </div>
        
      </div>
      </br>
    </div>
  </div>
</div>


<!-- Modal -->
<div class="modal fade" id="certReadyModal" tabindex="-1" role="dialog" aria-labelledby="certModalLabel" aria-hidden="true">
  <div class="modal-dialog" style="width:400px" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
        <h4 class="modal-title">Register certificate on server</h4>
      </div>
      <div class="modal-body">
        <div id="cert_wait">
         <img src="common/css/throbber.gif" width="16" /> Wait...
        </div>
        <section id="p12-cert">
           <h5>PKCS12 Credentials Store</h5>
           <a id="pkcs12-download" download="certificate.p12">Download PKCS12</a>
           <br/>
           <h >Please save PKCS12 Credentials Store on local disk and click Register.</h5>
        </section>
        </p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
        <button id="upload_cert" type="button" class="btn btn-primary">Register</button>
      </div>
    </div>
  </div>
</div>


<!-- Modal -->
<div class="modal fade" id="csrModal" tabindex="-1" role="dialog" aria-labelledby="certModalLabel" aria-hidden="true">
  <div class="modal-dialog" style="width:500px" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
        <h4 class="modal-title">Create a Certificate Request for a Certificate Authority</h4>
      </div>
      <div class="modal-body">
        <div class="row">
          <div class="col-md-12">
            <label for="csr_name">Name:</label>
            <input type="text" class="form-control" id="csr_name" value="smalinin1" />
          </div>
          <div class="col-md-12">&nbsp;</div>
        </div>
        <div class="row">
          <div class="col-md-12">
            <label for="csr_email">Email:</label>
            <input type="email" class="form-control" id="csr_email" />
          </div>
          <div class="col-md-12">&nbsp;</div>
        </div>

        <div class="row">
          <div class="col-md-12">
            <label for="csr_Org">Organization:</label>
            <input type="text" class="form-control" id="csr_Org" />
          </div>
          <div class="col-md-12">&nbsp;</div>
        </div>
        <div class="row">
          <div class="col-md-12">
            <label for="csr_OrgUnit">Organizational Unit:</label>
            <input type="text" class="form-control" id="csr_OrgUnit" />
          </div>
          <div class="col-md-12">&nbsp;</div>
        </div>
        <div class="row">
          <div class="col-md-12">
            <label for="csr_City">City (Locality):</label>
            <input type="text" class="form-control" id="csr_City" />
          </div>
          <div class="col-md-12">&nbsp;</div>
        </div>
        <div class="row">
          <div class="col-md-12">
            <label for="csr_State">State:</label>
            <input type="text" class="form-control" id="csr_State" />
          </div>
          <div class="col-md-12">&nbsp;</div>
        </div>
        <div class="row">
          <div class="col-md-4">
            <label for="csr_Country">Country:</label>
            <input type="text" class="form-control" id="csr_Country" />
          </div>
          <div class="col-md-12">&nbsp;</div>
        </div>

        <div class="row">
          <div class="col-md-12">
            <label for="csr_pwd">Password for Private Key :</label>
            <input type="password" class="form-control" id="csr_pwd" />
          </div>
          <div class="col-md-12">&nbsp;</div>
        </div>
        <div class="row">
          <div class="col-md-12">
            <label for="csr_pwd1">Confirm Password:</label>
            <input type="password" class="form-control" id="csr_pwd1" />
          </div>
          <div class="col-md-12">&nbsp;</div>
        </div>

        </p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
        <button id="gen-csr-btn" type="button" class="btn btn-primary">Continue</button>
      </div>
    </div>
  </div>
</div>



<!-- Modal -->
<div class="modal fade" id="csrReadyModal" tabindex="-1" role="dialog" aria-labelledby="certModalLabel" aria-hidden="true">
  <div class="modal-dialog" style="width:600px" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
        <h4 class="modal-title">Certificate Request & PrivateKey</h4>
      </div>
      <div class="modal-body">
        <div id="csr_wait">
         <img src="common/css/throbber.gif" width="16" /> Wait...
        </div>
        <section id="csr">
          <h5>Certificate Request in PEM Format</h5>
            <a id="csr-download" download="csr.pem">Download Certificate Request</a>
            <pre id="csr-text"></pre>
        </section>
        <br/>
        </p>
        <section id="csr">
          <h5>Certificate Private Key in PEM Format</h5>
          <a id="pkey-download" download="privateKey.pem">Download Private Key</a>
        </section>
        </p>
        <h >Please save certificate request and private key on local disk.</h5>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
      </div>
    </div>
  </div>
</div>


</body>
<script src="/common/js/solid-auth-client.bundle.js"></script>
<!--
<script src="/common/js/auth-buttons.js"></script>
-->
<script type="text/javascript">

(({ auth }) => {
  // Wire up DOM elements
  const [loginButton, logoutButton, registerButton, accountSettings] =
    ['login', 'logout', 'register', 'accountSettings'].map(id =>
      document.getElementById(id) || document.createElement('a'))
  loginButton.addEventListener('click', login)
  logoutButton.addEventListener('click', logout)
  registerButton.addEventListener('click', register)

  // Track authentication status and update UI
  auth.trackSession(session => {
    const loggedHref = document.getElementById('logged-href')
    const loggedIn = !!session
    const isOwner = loggedIn && getOriginFromWebId(session.webId) === location.origin
    loginButton.classList.toggle('hidden', loggedIn)
    logoutButton.classList.toggle('hidden', !loggedIn)
    accountSettings.classList.toggle('hidden', !isOwner)
    if (loggedIn) {
      if (session.webId) {
        loggedHref.style.display = 'initial'
        loggedHref.href = session.webId
        loggedHref.title = session.webId
      }

      document.getElementById('update_cert').disabled = false

    } else {
      loggedHref.style.display = 'none'
      loggedHref.href = ''
      loggedHref.title = ''
      document.getElementById('update_cert').disabled = true
    }

  })

  // Log the user in on the client and the server
  async function login () {
    const session = await auth.popupLogin()
    if (session) {
      // Make authenticated request to the server to establish a session cookie
      const {status} = await auth.fetch(location, { method: 'HEAD' })
      if (status === 401) {
        alert(`Invalid login.\n\nDid you set ${session.idp} as your OIDC provider in your profile ${session.webId}?`)
        await auth.logout()
      }
      // Now that we have a cookie, reload to display the authenticated page
      location.reload()
    }
  }

  // Log the user out from the client and the server
  async function logout () {
    await auth.logout()
    location.reload()
  }

  // Redirect to the registration page
  function register () {
    const registration = new URL('/register', location)
    registration.searchParams.set('returnToUrl', location)
    location.href = registration
  }

    function getOriginFromWebId(webId) {
      if (window.URL.prototype) {
        return new URL(webId).origin;
      }
      var uriParts = webId.split('/');
      return uriParts[0] + '//' + uriParts[2];
    }

})(solid);


(function () {
    'use strict'
    var certData = {};
    var certDays = 60;
    const webId = '{{webId}}';


    var init = window.location.hash === '#init';
    var update_delegator_profile = document.querySelector('#update_delegator_profile');
    if (update_delegator_profile) {
      update_delegator_profile.hidden = !init;
    }
  
    getCertDays();
  
    var btnLoad = document.getElementById('load_btn');
    if (btnLoad)
      btnLoad.addEventListener('click', updateData);

    var btnShowGenCert = document.getElementById('update_cert');
    btnShowGenCert.addEventListener('click', showGenCertificate);
    var btnUploadCert = document.getElementById('upload_cert');
    btnUploadCert.addEventListener('click', uploadCertificate);
    var btnShowGenCSR = document.getElementById('create-csr');
    btnShowGenCSR.addEventListener('click', showGenCSR);

    var btnLoadPemFile = document.getElementById('cert-file-load');
    btnLoadPemFile.addEventListener('change', handleLoadPemFile);
    
    var btnUploadExistedCert = document.getElementById('upload-existed-cert');
    btnUploadExistedCert.addEventListener('click', uploadExistedCertificate);


    $('#collapseOne').on('show.bs.collapse', function () {
      $('#collapseTwo').collapse('hide');
    })
    $('#collapseTwo').on('show.bs.collapse', function () {
      $('#collapseOne').collapse('hide');
    })

    var btnGenCert = document.getElementById('gen-cert-btn');
    btnGenCert.addEventListener('click', genCertificate);

    var btnGenCsr = document.getElementById('gen-csr-btn');
    btnGenCsr.addEventListener('click', genCSRequest);
  

    function updateData() {
      var prof_url = '{{tlsCertWebid}}';
      var delegator = '{{webId}}';
      var rel_add = '\n <'+prof_url+'> <http://www.openlinksw.com/schemas/cert#onBehalfOf>  <'+delegator+'> . \n';
      var file_url = new URL(prof_url);

      if (file_url.protocol === 'http:')
        file_url.protocol = 'https:';

      file_url.hash = '';

      event.preventDefault();

      var query = `INSERT { <${prof_url}> <http://www.openlinksw.com/schemas/cert#onBehalfOf>  <${delegator}> . }`;

      fetch(file_url.href,
        { method: 'PATCH', 
          headers: {
            'Content-Type': 'application/sparql-update; charset=utf-8'
          },
          credentials: 'include', 
          body: query
        })
       .then(function(response) {
          if (!response.ok) {
            throw new Error('Network update request was not ok. HTTP='+response.status+'  '+response.statusText);
          }
          alert('Your profile file '+prof_url+' was updated.');
       })
       .catch(function(error) {
         alert(error);
       }) 
    }

    function showGenCertificate() {

      document.getElementById('cert_pwd').value = '';
      document.getElementById('cert_pwd1').value = '';
      document.getElementById('upload_cert').disabled = true;
      document.getElementById('cert-data').value = '';
      document.getElementById('cert-file-load').value = '';

      $('#certModal').modal('show');
    }


    function showGenCSR() {

      document.getElementById('csr_pwd').hidden = true;
      document.getElementById('csr_pwd1').hidden = true;

      $('#csrModal').modal('show');
    }


    function genCSRequest() {
      certData = {};

      var name = document.getElementById('csr_name').value;
      var email = document.getElementById('csr_email').value;
      var certOrg = document.getElementById('csr_Org').value;
      var certOrgUnit = document.getElementById('csr_OrgUnit').value;
      var certCity = document.getElementById('csr_City').value;
      var certState = document.getElementById('csr_State').value;
      var certCountry = document.getElementById('csr_Country').value;
      var certPwd = document.getElementById('csr_pwd').value;
      var certPwd1 = document.getElementById('csr_pwd1').value;

      if (certCountry.length > 0 && certCountry.length!=2) {
        alert('Country must be two characters');
        return
      }
      if (name.length < 1) {
        alert('Name is empty');
        return
      }

      if (certPwd != certPwd1)  {
        alert('Confirm Private Key password with properly value');
        return
      }


      document.getElementById('csr-download').removeAttribute('href');
      document.getElementById('pkey-download').removeAttribute('href');
      document.getElementById('csr-text').textContent = '';
      document.getElementById('csr_wait').hidden = false;

      $('#csrModal').modal('hide');
      $('#csrReadyModal').modal('show');

      setTimeout(function() {

        certData = genCSR(name, email, certOrg, certOrgUnit, certCity, certState, certCountry, webId, certPwd);

        document.getElementById('csr-text').textContent = certData.pem;

        var csrUrl = "data:application/octet-stream;charset=UTF-8;base64," + btoa(certData.pem);
        document.getElementById("csr-download").setAttribute("href", csrUrl);
        var pkeyUrl = "data:application/octet-stream;charset=UTF-8;base64," + btoa(certData.pkey);
        document.getElementById("pkey-download").setAttribute("href", pkeyUrl);
        document.getElementById('csr_wait').hidden = true;


      }, 500);


      return false;
    }

  
    function genCertificate() {
      certData = {};

      var name = document.getElementById('cert_name').value;
      var email = document.getElementById('cert_email').value;
      var certOrg = document.getElementById('cert_Org').value;
      var certOrgUnit = document.getElementById('cert_OrgUnit').value;
      var certCity = document.getElementById('cert_City').value;
      var certState = document.getElementById('cert_State').value;
      var certCountry = document.getElementById('cert_Country').value;
      var certPwd = document.getElementById('cert_pwd').value;
      var certPwd1 = document.getElementById('cert_pwd1').value;

      if (certPwd.length < 1)  {
        alert('Certificate password could not be empty');
        return
      }
      if (certPwd != certPwd1)  {
        alert('Confirm certificate password with properly value');
        return
      }

      if (certCountry.length > 0 && certCountry.length!=2) {
        alert('Country must be two characters');
        return
      }
      if (name.length < 1) {
        alert('Name is empty');
        return
      }

      document.getElementById('cert_pwd').value = '';
      document.getElementById('cert_pwd1').value = '';
      document.getElementById('cert_wait').hidden = false;
      document.getElementById('p12-cert').hidden = true;
      document.getElementById('pkcs12-download').removeAttribute('href');

      $('#certModal').modal('hide');
      $('#certReadyModal').modal('show');

      setTimeout(function() {
        certData = genCert(name, email, certOrg, certOrgUnit, certCity, certState, certCountry, webId, certPwd);

        var p12Url = 'data:application/x-pkcs12;base64,' + certData.pkcs12B64;
        document.getElementById('pkcs12-download').setAttribute('href', p12Url);
        document.getElementById('p12-cert').hidden = false;
        document.getElementById('cert_wait').hidden = true;
        document.getElementById('upload_cert').disabled = false;

      }, 500);

      return false;
    }


    function uploadExistedCertificate() {
      var pki = forge.pki;
      certData = {};
      var cert;
      var pemData = document.getElementById('cert-data').value;

      if (pemData.length < 1) {
        alert('Empty certificate');
        return
      }

      certData.pem = pemData;

      try {
        cert = pki.certificateFromPem(pemData);
        if (!cert)
          throw new Error('Could not parse Certificate PEM data');

        var ext_webId;
        var ext = cert.getExtension('subjectAltName');
        if (ext !== null && ext.altNames) {
          for(var i = 0; i < ext.altNames.length; ++i) {
            var altName = ext.altNames[i];
            if(altName.type === 6) {
              ext_webId = altName.value;
              break;
            }
          }
        }
        if (!ext_webId) {
          throw new Error('Could not found WebId in Certificate');
        }
        if (ext_webId!==webId) {
          throw new Error(`Found a wrong WebID=${webId} in Certificate `);
        }

      } catch(e) {
        alert(e);
        return
      }

      uploadCertificate();
    }


    function uploadCertificate() {
      var formData  = new URLSearchParams();
      formData.append('username', '{{username}}');
      formData.append('certificatePEM', certData.pem);
      formData.append('certificatePKCS12', certData.pkcs12B64);

      fetch('/api/accounts/cert_new',
        { method: 'POST', 
          headers: {
          'Accept': 'text/html, text/plain, *.*',
          'Content-Type': 'application/x-www-form-urlencoded; charset=utf-8'
          },
          credentials: 'include', 
          body: formData
      })
      .then(function(response) {
        if (!response.ok) {
          if (response.status==401) {
            throw new Error('HTTP='+response.status+'  '+response.statusText+'. ReLogin to your account');
          }
          else {
            throw new Error('HTTP='+response.status+'  '+response.statusText);
          }
        } else {
          document.getElementById('upload_cert').disabled = true;
          var s = 'Certificate was registred on server \n'+
             ' The following actions have been applied re. WebID-TLS protocol usage:\n'+
             '- WebID-Profile Relations Update re. Public Key (modulus and exponent)\n';
          if (certData.pkcs12B64 && certData.pkcs12B64.length > 1) {
              s += '- PKCS#12 identity card saved to ~profile folder\n';
          }

          $('#certReadyModal').modal('hide');
          $('#certModal').modal('hide');
          alert(s);
        }
      })
      .catch(function(error) {
        $('#certReadyModal').modal('hide');
        $('#certModal').modal('hide');
        alert(error);
      })
    }

 
    function addDays(date, days) {
      var result = new Date(date);
      result.setDate(result.getDate() + days);
      return result;
    }

   function genCert(certName, certEmail, certOrg, certOrgUnit, certCity, certState, certCountry, webId, pwd) {
     var pki = forge.pki;

     // generate a keypair and create an X.509v3 certificate
     var keys = pki.rsa.generateKeyPair(2048);
     var cert = pki.createCertificate();
     cert.publicKey = keys.publicKey;
     // NOTE: serialNumber is the hex encoded value of an ASN.1 INTEGER.
     // Conforming CAs should ensure serialNumber is:
     // - no more than 20 octets
     // - non-negative (prefix a '00' if your value starts with a '1' bit)
     cert.serialNumber = (Date.now()).toString(16);

     cert.validity.notBefore = new Date();
     cert.validity.notAfter = addDays(new Date(), 60);
//   cert.validity.notAfter.setFullYear(cert.validity.notBefore.getFullYear() + 1)

     var attrs = [];
     if (certName && certName.length > 1) {
       attrs.push({ name: 'commonName', value: certName });
     }

     if (certCountry && certCountry.length > 1) {
        attrs.push({ name: 'countryName', value: certCountry });
     }

     if (certState && certState.length > 1) {
        attrs.push({ shortName: 'ST', value: certState });
     }
     if (certCity && certCity.length > 1) {
        attrs.push({ name: 'localityName', value: certCity });
     }
     if (certOrgUnit && certOrgUnit.length > 1) {
        attrs.push({ name: 'organizationalUnitName', value: certOrgUnit });
     }

     if (certOrg && certOrg.length > 1) {
        attrs.push({ name: 'organizationName', value: certOrg });
     } else {
        attrs.push({ name: 'organizationName', value: 'WebID' });
     }
     if (certEmail && certEmail.length > 1) {
        attrs.push({ name: 'emailAddress', value: certEmail});
     }

     cert.setSubject(attrs);
     cert.setIssuer(attrs);
     cert.setExtensions([
       { name: 'basicConstraints',  cA: true,  critical: true}, 
       { name: 'keyUsage',  digitalSignature: true }, 
       { name: 'extKeyUsage', clientAuth: true}, 
       { name: 'nsCertType', client: true}, 
       { name: 'subjectAltName',
           altNames: [{
             type: 6, // URI
             value: webId
           }]
       }, 
       { name: 'subjectKeyIdentifier'}
     ])

     cert.sign(keys.privateKey, forge.md.sha512.create());

     var pemCert = pki.certificateToPem(cert);

     var p12Asn1 = forge.pkcs12.toPkcs12Asn1(keys.privateKey, [cert], pwd,
          {generateLocalKeyId: true, 
           friendlyName: 'solid-cert',
           algorithm: '3des'
           });

     var p12Der = forge.asn1.toDer(p12Asn1).getBytes();
     var p12B64 = forge.util.encode64(p12Der);

     return {pem: pemCert, pkcs12B64: p12B64};
   }


   function genCSR(certName, certEmail, certOrg, certOrgUnit, certCity, certState, certCountry, webId, pwd) {
     var pki = forge.pki;

     // generate a keypair and create an X.509v3 certificate
     var keys = pki.rsa.generateKeyPair(2048);

     var csr = pki.createCertificationRequest();
     csr.publicKey = keys.publicKey;

     var attrs = [];
     if (certName && certName.length > 1) {
       attrs.push({ name: 'commonName', value: certName });
     }

     if (certCountry && certCountry.length > 1) {
        attrs.push({ name: 'countryName', value: certCountry });
     }

     if (certState && certState.length > 1) {
        attrs.push({ shortName: 'ST', value: certState });
     }

     if (certCity && certCity.length > 1) {
        attrs.push({ name: 'localityName', value: certCity });
     }
     if (certOrgUnit && certOrgUnit.length > 1) {
        attrs.push({ name: 'organizationalUnitName', value: certOrgUnit });
     }

     if (certOrg && certOrg.length > 1) {
        attrs.push({ name: 'organizationName', value: certOrg });
     } else {
        attrs.push({ name: 'organizationName', value: 'WebID' });
     }
     if (certEmail && certEmail.length > 1) {
        attrs.push({ name: 'emailAddress', value: certEmail});
     }

     csr.setSubject(attrs);

// set (optional) attributes
     csr.setAttributes([
//     { name: 'challengePassword',  value: 'password'}, 
//     { name: 'unstructuredName',  value: 'My Company, Inc.'}, 
     
       { name: 'extensionRequest',
          extensions: [
           { name: 'subjectAltName',  
              altNames: [{
               type: 6,
               value: webId
              }]
           },
           { name: 'keyUsage',  digitalSignature: true },
           { name: 'extKeyUsage', clientAuth: true}
           ]
       }
     ]);

     csr.sign(keys.privateKey, forge.md.sha512.create());

     var pemCSR = pki.certificationRequestToPem(csr);
     var pemPKey;

     if (pwd.length > 0) {
       var ekey = pki.encryptPrivateKeyInfo(pki.privateKeyToAsn1(keys.privateKey), 
                                     pwd,
                                     { algorithm: '3des',
                                       prfAlgorithm: 'sha512'
                                     });
       pemPKey = pki.encryptedPrivateKeyToPem(ekey);
     } else {
       pemPKey = pki.privateKeyToPem(keys.privateKey);
     }

     return {pem: pemCSR, pkey: pemPKey};
   }


   function handleLoadPemFile(evt) {
     var tempReader = new FileReader();

     var currentFiles = evt.target.files;

     // noinspection AnonymousFunctionJS
     tempReader.onload = function (event) {
  	// noinspection JSUnresolvedVariable
	var certBuffer = event.target.result;
	var fld = document.getElementById('cert-data');
	fld.value = ab2str(certBuffer);
     };

     tempReader.readAsArrayBuffer(currentFiles[0]);
   }

   function ab2str(buf) {
     return String.fromCharCode.apply(null, new Uint8Array(buf));
   }

   function getCertDays() {
     fetch('/certdays',
          { method: 'GET', 
            headers: {
              'Accept': 'text/plain; charset=utf-8'
            },
            credentials: 'include'
          })
        .then(function(response) {
          if (response.ok) {
            response.text().then((s)=> {
              var days = parseInt(s, 10);
              if (days > 0) {
                certDays = days;
              }
            })
          }
        })
   }

})();

</script>
</html>
