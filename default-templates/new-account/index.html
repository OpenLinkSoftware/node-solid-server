<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Set content in the next line to false if you do not want your homepage to be automatically updated whenever a new version becomes available. -->
  <meta name="solid-allow-automatic-updates" content="true">
  <title>Personal Data Space (or POD) {{#if name}} of {{name}} {{/if}}</title>
  <link rel="stylesheet" href="/common/css/bootstrap.min.css">
  <link rel="stylesheet" href="/common/css/solid.css">

  <style>
    .session-action {
      margin-right: 15px;
    }


    .dettable {
      border-collapse: separate;
      border-spacing: 0;
      width: 100%;
      border: solid #ccc 1px;
      -moz-border-radius: 6px;
      -webkit-border-radius: 6px;
      border-radius: 6px;
      font-family: 'trebuchet MS' , 'Lucida sans' , Arial;
      font-size: 14px;
      color: #444;
    }

    .dettable > tbody > tr > td, .footable > thead > tr > th {
      border-left: 1px solid #ccc;
      border-top: 1px solid #ccc;
      padding: 4px;
      text-align: left;
    }

  </style>

  <script src="common/js/jquery.min.js"></script>
  <script src="common/js/bootstrap.min.js"></script>
  <script src="common/js/forge.min.js"></script>
  <script src="common/js/rdfstore_min.js"></script>
  <script src="common/js/webid_loader.js"></script>

</head>
<body>
<div class="container">
  <nav class="navbar navbar-default">
    <div class="container-fluid">
      <div class="navbar-header">
        <a href="/" class="navbar-brand">Personal Data Space (POD)</a>
      </div>
      <div class="nav navbar-right navbar-form">
        <a id="logged-href" href="" title="" class="hidden" >
          <span class="glyphicon glyphicon-user"></span>
        </a>
        <span>&nbsp&nbsp</span>
        <button id="login"  type="button" class="hidden btn btn-default btn-success">Log in</button>
        <button id="logout" type="button" class="hidden btn btn-danger">Log out</button>
      </div>
    </div>
  </nav>

  <p class="lead">
    <span>
      This is a public homepage of <a href="{{webId}}">{{#if name}} {{name}} {{/if}}</a>
    </span>
  </p>

{{#if tlsCertWebid}}
  <section id="update_delegator_profile" class="hidden">
    <div class="list-group">
      <p class="lead">
        If you want to make use of the WebID-TLS+Delegation authentication protocol, add the following RDF statement to your Delegate's WebID-Profile Document or click "Update Delegator WebID-Profile Doc" button to attempt this action right now, assuming you are logged in using a WebID that Read+Write privileges on the target WebID-Profile document.
        <pre>
&lt;{{tlsCertWebid}}&gt; &lt;http://www.openlinksw.com/schemas/cert#onBehalfOf&gt; &lt;{{webId}}&gt; .
        </pre>
        <span>
          <input id="load_btn" class="btn btn-primary" value=" Update Delegator WebID-Profile Doc " type="button">
        </span>
      </p>
    </div>  
  </section>
{{/if}}
  
  <section>
    <h1>Data</h1>
    <div class="list-group">
      <a href="/profile/card" target="_blank" class="list-group-item">
        <span class="lead">Profile</span>
        <span class="badge">public</span>
      </a>
      <a href="/inbox/" target="_blank" class="list-group-item">
        <span class="lead">Inbox</span>
        <span class="badge">private</span>
      </a>
      <a href="/public/" target="_blank" class="list-group-item">
        <span class="lead">Public Folder</span>
        <span class="badge">public</span>
      </a>
      <a href="/private/" target="_blank" class="list-group-item">
        <span class="lead">Private Folder</span>
        <span class="badge">private</span>
      </a>
    </div>
  </section>
  
  <section>
    <h1>Apps</h1>
    <div class="list-group">
      <a href="/common/plume/" target="_blank" class="list-group-item">
        <span class="lead">Plume blog</span>
      </a>
      <a href="https://github.com/solid/userguide" target="_blank" class="list-group-item">
        <span class="lead">Getting started with Solid and Data Browser</span>
      </a>
      <a href="/account/password/reset" class="list-group-item">
        <span class="lead">Reset Password</span>
      </a>
    </div>
  </section>

  <section class="hidden" id="account-settings">
    <h1>Account settings</h1>
    <div class="list-group">
<!--
      <div id="update_profile" class="list-group-item">
-->
      <div class="list-group-item">
        <button type="button" class="btn" id="create_cert">Update Credentials Document</button>
      </div>
      <div class="list-group-item">
        <button type="button" class="btn" id="create-csr">Generate Credentials Signature Request</button>
      </div>
{{#if tlsCertWebid}}
      <div class="list-group-item">
        <p>
          If you want to make use of the WebID-TLS+Delegation authentication protocol, add the following RDF statement to your Delegate's WebID-Profile Document or click "Update Delegator WebID-Profile Doc" button to attempt this action right now, assuming you are logged in using a WebID that Read+Write privileges on the target WebID-Profile document.
          <pre>
&lt;{{tlsCertWebid}}&gt; &lt;http://www.openlinksw.com/schemas/cert#onBehalfOf&gt; &lt;{{webId}}&gt; .
          </pre>
          <span>
            <input id="load_btn" class="btn btn-primary" value=" Update Delegator WebID-Profile Doc " type="button">
          </span>
        </p>
      </div>
{{/if}}
      <a href="/account/delete/" class="list-group-item">
        <span class="lead">Delete account</span>
      </a>
    </div>
  </section>
  
<div class="modal fade" id="certModal" tabindex="-1" role="dialog" aria-labelledby="certModalLabel" aria-hidden="true">
  <div class="modal-dialog" style="width:600px" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
        <h4 class="modal-title">Create and register certificate</h4>
      </div>
      <div class="modal-body">
      
        <div class="accordion" id="accordion-cert">
          <div class="card">
            <div class="card-header" id="heading1">
              <h5 class="mb-0">
                <button class="btn btn-link collapsed" type="button" data-toggle="collapse" data-target="#collapse1" aria-expanded="false" aria-controls="collapse1">
                  Create Self-Signed Certificate
                </button>
              </h5>
            </div>
        
            <div id="collapse1" class="collapse" aria-labelledby="heading1" data-parent="#accordion-cert">
              <div class="card-body">
                <div class="row">
                  <div class="col-md-12">
                    <label for="cert_name">Name:</label>
                    <input type="text" class="form-control" id="cert_name" value="smalinin" />
                  </div>
                  <div class="col-md-12">&nbsp;</div>
                </div>
                <div class="row">
                  <div class="col-md-12">
                    <label for="cert_email">Email:</label>
                    <input type="email" class="form-control" id="cert_email" />
                  </div>
                  <div class="col-md-12">&nbsp;</div>
                </div>
                <div class="row">
                  <div class="col-md-12">
                    <label for="cert_Org">Organization:</label>
                    <input type="text" class="form-control" id="cert_Org" />
                  </div>
                  <div class="col-md-12">&nbsp;</div>
                </div>
                <div class="row">
                  <div class="col-md-12">
                    <label for="cert_OrgUnit">Organizational Unit:</label>
                    <input type="text" class="form-control" id="cert_OrgUnit" />
                  </div>
                  <div class="col-md-12">&nbsp;</div>
                </div>
                <div class="row">
                  <div class="col-md-12">
                    <label for="cert_City">City (Locality):</label>
                    <input type="text" class="form-control" id="cert_City" />
                  </div>
                  <div class="col-md-12">&nbsp;</div>
                </div>
                <div class="row">
                  <div class="col-md-12">
                    <label for="cert_State">State:</label>
                    <input type="text" list="c_states" class="form-control" id="cert_State" />
                    <datalist id="c_states">
                    </datalist>
                  </div>
                  <div class="col-md-12">&nbsp;</div>
                </div>
                <div class="row">
                  <div class="col-md-12">
                    <label for="cert_Country">Country:</label>
                      <select class="form-control" id="cert_Country">
                        <option value="" ></option>
                      </select>
                  </div>
                  <div class="col-md-12">&nbsp;</div>
                </div>
                <div class="row">
                  <div class="col-md-12">
                    <label id="lb_cert_pwd" for="cert_pwd">Password for PKCS12 Credentials Store:</label>
                    <input type="password" class="form-control" id="cert_pwd" />
                  </div>
                  <div class="col-md-12">&nbsp;</div>
                </div>
                <div class="row">
                  <div class="col-md-12">
                    <label for="cert_pwd1">Confirm Password:</label>
                    <input type="password" class="form-control" id="cert_pwd1" />
                  </div>
                  <div class="col-md-12">&nbsp;</div>
                </div>

                </p>
                <hr>
                <div class="row pull-right">
                  <div class="col-md-12">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    &nbsp;&nbsp;
                    <button id="gen-cert-btn" type="button" class="btn btn-primary pull-right">Continue</button>
                  </div>
                </div>
                </br>
             </div>
            </div>
          </div>

          <div class="card">
            <div class="card-header" id="heading2">
              <h5 class="mb-0">
                <button class="btn btn-link collapsed" type="button" data-toggle="collapse" data-target="#collapse2" aria-expanded="false" aria-controls="collapse2">
                  Upload existed certificate
                </button>
              </h5>
            </div>
            <div id="collapse2" class="collapse" aria-labelledby="heading2" data-parent="#accordion-cert">
              <div class="card-body">
                <div class="row">
                  <div class="col-md-12">
                    <label for="cert-data">Certificate PEM data:</label>
                    <textarea class="form-control" id="cert-data" rows="10" style="white-space: nowrap;  overflow: auto;"></textarea>
                    </p>
                    <input type="file" id="cert-file-load" title="Load Certificate pem file">
                  </div>
                </div>
                </p>
                <hr>
                <div class="row pull-right">
                  <div class="col-md-12">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    &nbsp;&nbsp;
                    <button id="upload-existed-cert" type="button" class="btn btn-primary pull-right">Continue</button>
                  </div>
                </div>
                </br>
              </div>
            </div>
          </div>

          <div class="card">
            <div class="card-header" id="heading3">
              <h5 class="mb-0">
                <button class="btn btn-link collapsed" type="button" data-toggle="collapse" data-target="#collapse3" aria-expanded="false" aria-controls="collapse3" title="Setting up Delegate Relations for WebID-TLS+Delegation authentication protocol usage">
                  Setup Delegate(s)
                </button>
              </h5>
            </div>
            <div id="collapse3" class="collapse" aria-labelledby="heading3" data-parent="#accordion-cert">
              <div class="card-body">
<!-- ==================================== -->
                <form id="delegate-create" class="form-horizontal">
                  <div class="form-group row">
                    <label for="delegate_uri" class="col-md-2 control-label">Delegate&nbsp;URI:</label>
                    <div class="col-md-10">
                      <input type="text" class="form-control" id="delegate_uri" value="">
                      <button id="btn-delegate_uri" type="button" class="btn">
                        <img class="hidden" id="delegate_wait" src="common/css/throbber.gif" width="16" />
                        Fetch Profile 
                      </button>
                    </div>
                  </div>
                  <div class="form-group row">
                    <div class="col-md-12">
                      <button id="btn-delegate_cert_key" style="text-align:left" class="btn col-md-12" type="button">Certificate Key<span class="caret pull-right" style="margin-top:10px"></span></button>
                    </div> 
        
                    <div class="col-md-12">
                      <label for="delegate-text" class="control-label">Relations for uploading to Delegate profile:</label>
                      <textarea id="delegate-text" class="form-control hidden1" style="width: 570px; height: 130px; overflow:scroll; white-space:nowrap;">
                      </textarea>
                      <button id="btn-update_delegate" type="button" class="btn btn-primary ">
                        Update Delegate Profile 
                      </button>
        
                    </div>
                  </div>
        
                  <div class="form-group row">
                    <div class="col-md-12">
                      <label for="delegator-text" class="control-label">Relations for uploading to Delegator profile:</label>
                      <textarea id="delegator-text" class="form-control hidden1" style="width: 570px; height: 170px; overflow:scroll; white-space:nowrap;">
                      </textarea>
                      <button id="btn-update_delegator" type="button" class="btn btn-primary ">
                        Update Delegator Profile 
                      </button>
                    </div>
                  </div>
                </form>
        
                <div id="u_wait" class="hidden">
                 <img src="common/css/throbber.gif" width="16" /> Wait...
                 <div id="u_msg"></div>
                </div>
        
<!-- ==================================== -->
              </div>
            </div>
          </div>

        </div>
        
      </div>
      </br>
    </div>
  </div>
</div>


<!-- Modal -->
<div class="modal fade" id="certReadyModal" tabindex="-1" role="dialog" aria-labelledby="certModalLabel" aria-hidden="true" data-backdrop="static" data-keyboard="false">
  <div class="modal-dialog" style="width:600px" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
        <h4 class="modal-title">Register certificate on server</h4>
      </div>
      <div class="modal-body">
        <div id="cert_wait">
         <img src="common/css/throbber.gif" width="16" /> Wait...
        </div>
        <section id="p12-cert">
           <h5>PKCS12 Credentials Store</h5>
           <a id="pkcs12-download" download="certificate.p12">Download PKCS12</a>
           <br/>
           <h5>Please save PKCS12 Credentials Store on local disk and click Register.</h5>
        </section>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
        <button id="btn-upload_cert" type="button" class="btn btn-primary">Register</button>
      </div>
    </div>
  </div>
</div>


<!-- Modal -->
<div class="modal" id="cert-key-dlg" tabindex="-1" role="dialog" aria-hidden="true" data-backdrop="static" data-keyboard="false">
  <div class="modal-dialog" style="width:700px" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
        <h5 class="modal-title">Choose Certificate Key</h5>
      </div>
      <div class="modal-body">
        <div style="height:500px; overflow: auto;">
          <table id="cert-key-tbl" class="footable">
            <tbody id="keys_data">
            </tbody>
          </table>
        </div>
      </div>
      <div class="modal-footer">
        <button id="btn-cancel" type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
        <button id="btn-ok" type="button" class="btn btn-primary">Ok</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal -->
<div class="modal fade" id="csrModal" tabindex="-1" role="dialog" aria-labelledby="certModalLabel" aria-hidden="true">
  <div class="modal-dialog" style="width:500px" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
        <h4 class="modal-title">Create a Certificate Request for a Certificate Authority</h4>
      </div>
      <div class="modal-body">
        <div class="row">
          <div class="col-md-12">
            <label for="csr_name">Name:</label>
            <input type="text" class="form-control" id="csr_name" value="smalinin1" />
          </div>
          <div class="col-md-12">&nbsp;</div>
        </div>
        <div class="row">
          <div class="col-md-12">
            <label for="csr_email">Email:</label>
            <input type="email" class="form-control" id="csr_email" />
          </div>
          <div class="col-md-12">&nbsp;</div>
        </div>

        <div class="row">
          <div class="col-md-12">
            <label for="csr_Org">Organization:</label>
            <input type="text" class="form-control" id="csr_Org" />
          </div>
          <div class="col-md-12">&nbsp;</div>
        </div>
        <div class="row">
          <div class="col-md-12">
            <label for="csr_OrgUnit">Organizational Unit:</label>
            <input type="text" class="form-control" id="csr_OrgUnit" />
          </div>
          <div class="col-md-12">&nbsp;</div>
        </div>
        <div class="row">
          <div class="col-md-12">
            <label for="csr_City">City (Locality):</label>
            <input type="text" class="form-control" id="csr_City" />
          </div>
          <div class="col-md-12">&nbsp;</div>
        </div>
        <div class="row">
          <div class="col-md-12">
            <label for="csr_State">State:</label>
            <input type="text" list="csr_states" class="form-control" id="csr_State" />
            <datalist id="csr_states">
            </datalist>
          </div>
          <div class="col-md-12">&nbsp;</div>
        </div>
        <div class="row">
          <div class="col-md-12">
            <label for="csr_Country">Country:</label>
            <select class="form-control" id="csr_Country">
              <option value="" ></option>
            </select>
          </div>
          <div class="col-md-12">&nbsp;</div>
        </div>

        <div class="row">
          <div class="col-md-12">
            <label for="csr_pwd">Password for Private Key :</label>
            <input type="password" class="form-control" id="csr_pwd" />
          </div>
          <div class="col-md-12">&nbsp;</div>
        </div>
        <div class="row">
          <div class="col-md-12">
            <label for="csr_pwd1">Confirm Password:</label>
            <input type="password" class="form-control" id="csr_pwd1" />
          </div>
          <div class="col-md-12">&nbsp;</div>
        </div>

        </p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
        <button id="gen-csr-btn" type="button" class="btn btn-primary">Continue</button>
      </div>
    </div>
  </div>
</div>



<!-- Modal -->
<div class="modal fade" id="csrReadyModal" tabindex="-1" role="dialog" aria-labelledby="certModalLabel" aria-hidden="true">
  <div class="modal-dialog" style="width:600px" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
        <h4 class="modal-title">Certificate Request & PrivateKey</h4>
      </div>
      <div class="modal-body">
        <div id="csr_wait">
         <img src="common/css/throbber.gif" width="16" /> Wait...
        </div>
        <section id="csr">
          <h5>Certificate Request in PEM Format</h5>
            <a id="csr-download" download="csr.pem">Download Certificate Request</a>
            <pre id="csr-text"></pre>
        </section>
        <br/>
        </p>
        <section id="csr">
          <h5>Certificate Private Key in PEM Format</h5>
          <a id="pkey-download" download="privateKey.pem">Download Private Key</a>
        </section>
        </p>
        <h5>Please save certificate request and private key on local disk.</h5>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
      </div>
    </div>
  </div>
</div>


</body>
<script src="/common/js/solid-auth-client.bundle.js"></script>
<!--
<script src="/common/js/auth-buttons.js"></script>
-->
<script type="text/javascript">

(({ auth }) => {
  // Wire up DOM elements
  const [loginButton, logoutButton, registerButton, accountSettings] =
    ['login', 'logout', 'register', 'account-settings'].map(id =>
      document.getElementById(id) || document.createElement('a'))
  loginButton.addEventListener('click', login)
  logoutButton.addEventListener('click', logout)
  registerButton.addEventListener('click', register)

  // Track authentication status and update UI
  auth.trackSession(session => {
    const update_delegator_profile = document.getElementById('update_delegator_profile')
    const loggedHref = document.getElementById('logged-href')
    const loggedIn = !!session
    const isOwner = loggedIn && getOriginFromWebId(session.webId) === location.origin
    loginButton.classList.toggle('hidden', loggedIn)
    logoutButton.classList.toggle('hidden', !loggedIn)
    accountSettings.classList.toggle('hidden', !isOwner)
    if (loggedIn) {
      if (session.webId) {
        loggedHref.classList.remove('hidden')
        loggedHref.href = session.webId
        loggedHref.title = session.webId
      }

      document.getElementById('create_cert').disabled = false
      if (update_delegator_profile) {
        update_delegator_profile.classList.add('hidden')
      }

    } else {
      loggedHref.classList.add('hidden')
      loggedHref.href = ''
      loggedHref.title = ''
      document.getElementById('create_cert').disabled = true

      if (update_delegator_profile) {
        var init = (window.location.hash === '#init' || window.location.hash === '#admin');
        update_delegator_profile.classList.toggle('hidden', !init)
      }
    }

  })

  // Log the user in on the client and the server
  async function login () {
    const session = await auth.popupLogin()
    if (session) {
      // Make authenticated request to the server to establish a session cookie
      const {status} = await auth.fetch(location, { method: 'HEAD' })
      if (status === 401) {
        alert(`Invalid login.\n\nDid you set ${session.idp} as your OIDC provider in your profile ${session.webId}?`)
        await auth.logout()
      }
      // Now that we have a cookie, reload to display the authenticated page
      location.reload()
    }
  }

  // Log the user out from the client and the server
  async function logout () {
    await auth.logout()
    location.reload()
  }

  // Redirect to the registration page
  function register () {
    const registration = new URL('/register', location)
    registration.searchParams.set('returnToUrl', location)
    location.href = registration
  }

    function getOriginFromWebId(webId) {
      if (window.URL.prototype) {
        return new URL(webId).origin;
      }
      var uriParts = webId.split('/');
      return uriParts[0] + '//' + uriParts[2];
    }

})(solid);


(function () {
    'use strict'
  var certData = {};
  var gen = {};
  var delUpdater;
  var certDays = 60;
  const webId = '{{webId}}';

  var init = (window.location.hash === '#init' || window.location.hash === '#admin');

  function initCertGen()
  {
    var update_delegator_profile = document.querySelector('#update_delegator_profile');
    if (update_delegator_profile) {
       update_delegator_profile.classList.toggle('hidden', !init)
    }
    
    getCertDays();
  
    initCountries();
    delUpdater = new UpdateDelegate();


    var btnUpdate = document.querySelector('#load_btn')
    if (btnUpdate)
       btnUpdate.onclick = () => { updateData() }

    document.querySelector('#create_cert')
      .onclick = () => { showGenCertificate() }

    document.querySelector('#create-csr')
      .onclick = () => { showGenCSR() }

    document.querySelector('#cert-file-load')
      .onchange = (e) => { handleLoadPemFile(e) }
    
    document.querySelector('#upload-existed-cert')
      .onclick = () => { uploadExistedCertificate() }

    $('#collapse1').on('show.bs.collapse', function () {
      $('#collapse2').collapse('hide');
      $('#collapse3').collapse('hide');
    })
    $('#collapse2').on('show.bs.collapse', function () {
      $('#collapse1').collapse('hide');
      $('#collapse3').collapse('hide');
    })
    $('#collapse3').on('show.bs.collapse', function () {
      $('#collapse1').collapse('hide');
      $('#collapse2').collapse('hide');
    })

    document.querySelector('#gen-cert-btn')
      .onclick = () => { genCertificate() }

    document.querySelector('#gen-csr-btn')
      .onclick = () => { genCSRequest() }

    document.querySelector('#certModal #cert_Country')
      .onchange = (e) => {
        var sel_country = document.querySelector('#certModal #cert_Country option:checked').value;

        document.querySelector('#certModal #cert_State').value = '';

        var states_list = document.querySelector('#certModal #c_states');
        states_list.innerHTML = '';

        var states = null;
        for(var i=0; i< COUNTRIES.length; i++) {
          var c = COUNTRIES[i];
          if (c.ccode === sel_country) {
            states = c.states;
            break; 
          }
        }
        if (states) {
          for(var i=0; i < states.length; i++) {
            var el = document.createElement('option');
            el.value = states[i].sl;
            states_list.appendChild(el);
          }
        }
      }


    document.querySelector('#csrModal #csr_Country')
      .onchange = (e) => {
        var sel_country = document.querySelector('#csrModal #csr_Country option:checked').value;

        document.querySelector('#csrModal #csr_State').value = '';

        var states_list = document.querySelector('#csrModal #csr_states');
        states_list.innerHTML = '';

        var states = null;
        for(var i=0; i< COUNTRIES.length; i++) {
          var c = COUNTRIES[i];
          if (c.ccode === sel_country) {
            states = c.states;
            break; 
          }
        }
        if (states) {
          for(var i=0; i < states.length; i++) {
            var el = document.createElement('option');
            el.value = states[i].sl;
            states_list.appendChild(el);
          }
        }
      }

    document.querySelector('#certModal #btn-delegate_uri')
        .onclick = async () => {
          await delUpdater.fetchDelegate(gen, webId);
        };

    document.querySelector('#certModal #btn-delegate_cert_key')
        .onclick = async () => {
          if (!gen.delegate_keys || gen.delegate_keys.length == 0) {
             alert('Fetch Delegate profile at first.');
             return; 
          }
          delUpdater.showCertKeys(gen);
        };

    document.querySelector('#certModal #btn-update_delegate')
          .onclick = async () => {
            await delUpdater.uploadDelegate(gen, webId, certData);
          };
    document.querySelector('#certModal #btn-update_delegator')
          .onclick = async () => {
            await delUpdater.uploadDelegator(gen, webId, certData);
          };

  }

    
    function updateData() {
      var prof_url = '{{tlsCertWebid}}';
      var delegator = '{{webId}}';
      var rel_add = '\n <'+prof_url+'> <http://www.openlinksw.com/schemas/cert#onBehalfOf>  <'+delegator+'> . \n';
      var file_url = new URL(prof_url);

      if (file_url.protocol === 'http:')
        file_url.protocol = 'https:';

      file_url.hash = '';

      event.preventDefault();

      var query = `INSERT { <${prof_url}> <http://www.openlinksw.com/schemas/cert#onBehalfOf>  <${delegator}> . }`;

      solid.auth.fetch(file_url.href,
        { method: 'PATCH', 
          headers: {
            'Content-Type': 'application/sparql-update; charset=utf-8'
          },
          credentials: 'include', 
          body: query
        })
       .then(function(response) {
          if (!response.ok) {
            throw new Error('Network update request was not ok. HTTP='+response.status+'  '+response.statusText);
          }
          alert('Your profile file '+prof_url+' was updated.');
       })
       .catch(function(error) {
         alert(error);
       }) 
    }

    function showGenCertificate() {

      document.getElementById('cert_pwd').value = '';
      document.getElementById('cert_pwd1').value = '';
      document.getElementById('cert-data').value = '';
      document.getElementById('cert-file-load').value = '';

      $('#certModal').modal('show');
    }


    function showGenCSR() {

      document.getElementById('csr_pwd').hidden = true;
      document.getElementById('csr_pwd1').hidden = true;

      $('#csrModal').modal('show');
    }


    function genCSRequest() {
      certData = {};

      var name = document.getElementById('csr_name').value;
      var email = document.getElementById('csr_email').value;
      var certOrg = document.getElementById('csr_Org').value;
      var certOrgUnit = document.getElementById('csr_OrgUnit').value;
      var certCity = document.getElementById('csr_City').value;
      var certState = document.getElementById('csr_State').value;
      var certCountry = document.querySelector('#csrModal #csr_Country option:checked').value;
      var certPwd = document.getElementById('csr_pwd').value;
      var certPwd1 = document.getElementById('csr_pwd1').value;

      if (certCountry.length > 0 && certCountry.length!=2) {
        alert('Country must be two characters');
        return
      }
      if (name.length < 1) {
        alert('Name is empty');
        return
      }

      if (certPwd != certPwd1)  {
        alert('Confirm Private Key password with properly value');
        return
      }


      document.getElementById('csr-download').removeAttribute('href');
      document.getElementById('pkey-download').removeAttribute('href');
      document.getElementById('csr-text').textContent = '';
      document.getElementById('csr_wait').hidden = false;

      $('#csrModal').modal('hide');
      $('#csrReadyModal').modal('show');

      setTimeout(function() {

        certData = genCSR(name, email, certOrg, certOrgUnit, certCity, certState, certCountry, webId, certPwd);

        document.getElementById('csr-text').textContent = certData.pem;

        var csrUrl = "data:application/octet-stream;charset=UTF-8;base64," + btoa(certData.pem);
        document.getElementById("csr-download").setAttribute("href", csrUrl);
        var pkeyUrl = "data:application/octet-stream;charset=UTF-8;base64," + btoa(certData.pkey);
        document.getElementById("pkey-download").setAttribute("href", pkeyUrl);
        document.getElementById('csr_wait').hidden = true;


      }, 500);


      return false;
    }

  
    function genCertificate() {
      certData = {};
      gen = {};

      var name = document.getElementById('cert_name').value;
      var email = document.getElementById('cert_email').value;
      var certOrg = document.getElementById('cert_Org').value;
      var certOrgUnit = document.getElementById('cert_OrgUnit').value;
      var certCity = document.getElementById('cert_City').value;
      var certState = document.getElementById('cert_State').value;
      var certCountry = document.querySelector('#certModal #cert_Country option:checked').value;
      var certPwd = document.getElementById('cert_pwd').value;
      var certPwd1 = document.getElementById('cert_pwd1').value;

      if (certPwd.length < 1)  {
        alert('Certificate password could not be empty');
        return
      }
      if (certPwd != certPwd1)  {
        alert('Confirm certificate password with properly value');
        return
      }

      if (certCountry.length > 0 && certCountry.length!=2) {
        alert('Country must be two characters');
        return
      }
      if (name.length < 1) {
        alert('Name is empty');
        return
      }

      document.getElementById('cert_pwd').value = '';
      document.getElementById('cert_pwd1').value = '';
      document.getElementById('cert_wait').hidden = false;
      document.getElementById('p12-cert').hidden = true;
      document.getElementById('pkcs12-download').removeAttribute('href');


      DOM_qHide('#certReadyModal #btn-upload_cert');

      $('#certModal').modal('hide');
      $('#certReadyModal').modal('show');

      setTimeout(function() {
        certData = genCert(name, email, certOrg, certOrgUnit, certCity, certState, certCountry, webId, certPwd);

        var p12Url = 'data:application/x-pkcs12;base64,' + certData.pkcs12B64;
        document.getElementById('pkcs12-download').setAttribute('href', p12Url);
        document.getElementById('p12-cert').hidden = false;
        document.getElementById('cert_wait').hidden = true;
        document.getElementById('btn-upload_cert').disabled = false;

        DOM_qShow('#certReadyModal #btn-upload_cert');

        DOM_qSel('#certReadyModal #btn-upload_cert')
          .onclick = async () => {
            await uploadCertificate();
          };

      }, 500);

      return false;
    }


    function uploadExistedCertificate() {
      var pki = forge.pki;
      certData = {};
      var cert;
      var pemData = document.getElementById('cert-data').value;

      if (pemData.length < 1) {
        alert('Empty certificate');
        return
      }

      certData.pem = pemData;

      try {
        cert = pki.certificateFromPem(pemData);
        if (!cert)
          throw new Error('Could not parse Certificate PEM data');

        var ext_webId;
        var ext = cert.getExtension('subjectAltName');
        if (ext !== null && ext.altNames) {
          for(var i = 0; i < ext.altNames.length; ++i) {
            var altName = ext.altNames[i];
            if(altName.type === 6) {
              ext_webId = altName.value;
              break;
            }
          }
        }
        if (!ext_webId) {
          throw new Error('Could not found WebId in Certificate');
        }
        if (ext_webId!==webId) {
          throw new Error(`Found a wrong WebID=${webId} in Certificate `);
        }

      } catch(e) {
        alert(e);
        return
      }

      uploadCertificate();
    }


    function uploadCertificate() {
      var formData  = new URLSearchParams();
      formData.append('username', '{{username}}');
      formData.append('certificatePEM', certData.pem);
      formData.append('certificatePKCS12', certData.pkcs12B64);

      solid.auth.fetch('/api/accounts/cert_new',
        { method: 'POST', 
          headers: {
          'Accept': 'text/html, text/plain, *.*',
          'Content-Type': 'application/x-www-form-urlencoded; charset=utf-8'
          },
          credentials: 'include', 
          body: formData
      })
      .then(function(response) {
        if (!response.ok) {
          if (response.status==401) {
            throw new Error('HTTP='+response.status+'  '+response.statusText+'. ReLogin to your account');
          }
          else {
            throw new Error('HTTP='+response.status+'  '+response.statusText);
          }
        } else {
          document.getElementById('btn-upload_cert').disabled = true;
          var s = 'Certificate was registred on server \n'+
             ' The following actions have been applied re. WebID-TLS protocol usage:\n'+
             '- WebID-Profile Relations Update re. Public Key (modulus and exponent)\n';
          if (certData.pkcs12B64 && certData.pkcs12B64.length > 1) {
              s += '- PKCS#12 identity card saved to ~profile folder\n';
          }

//          $('#certReadyModal').modal('hide');
//          $('#certModal').modal('hide');
          alert(s);
        }
      })
      .catch(function(error) {
//        $('#certReadyModal').modal('hide');
//        $('#certModal').modal('hide');
        alert(error);
      })
    }

 
    function addDays(date, days) {
      var result = new Date(date);
      result.setDate(result.getDate() + days);
      return result;
    }

   function genCert(certName, certEmail, certOrg, certOrgUnit, certCity, certState, certCountry, webId, pwd) {
     var pki = forge.pki;

     // generate a keypair and create an X.509v3 certificate
     var keys = pki.rsa.generateKeyPair(2048);
     var cert = pki.createCertificate();
     cert.publicKey = keys.publicKey;
     // NOTE: serialNumber is the hex encoded value of an ASN.1 INTEGER.
     // Conforming CAs should ensure serialNumber is:
     // - no more than 20 octets
     // - non-negative (prefix a '00' if your value starts with a '1' bit)
     cert.serialNumber = (Date.now()).toString(16);

     cert.validity.notBefore = new Date();
     cert.validity.notAfter = addDays(new Date(), certDays);

     var attrs = [];
     if (certName && certName.length > 1) {
       attrs.push({ name: 'commonName', value: certName });
     }

     if (certCountry && certCountry.length > 1) {
        attrs.push({ name: 'countryName', value: certCountry });
     }

     if (certState && certState.length > 1) {
        attrs.push({ shortName: 'ST', value: certState });
     }
     if (certCity && certCity.length > 1) {
        attrs.push({ name: 'localityName', value: certCity });
     }
     if (certOrgUnit && certOrgUnit.length > 1) {
        attrs.push({ name: 'organizationalUnitName', value: certOrgUnit });
     }

     if (certOrg && certOrg.length > 1) {
        attrs.push({ name: 'organizationName', value: certOrg });
     } else {
        attrs.push({ name: 'organizationName', value: 'WebID' });
     }
     if (certEmail && certEmail.length > 1) {
        attrs.push({ name: 'emailAddress', value: certEmail});
     }

     cert.setSubject(attrs);
     cert.setIssuer(attrs);
     cert.setExtensions([
       { name: 'basicConstraints',  cA: true,  critical: true}, 
       { name: 'keyUsage',  digitalSignature: true }, 
       { name: 'extKeyUsage', clientAuth: true}, 
       { name: 'nsCertType', client: true}, 
       { name: 'subjectAltName',
           altNames: [{
             type: 6, // URI
             value: webId
           }]
       }, 
       { name: 'subjectKeyIdentifier'}
     ])

     cert.sign(keys.privateKey, forge.md.sha512.create());

     var pemCert = pki.certificateToPem(cert);

     var p12Asn1 = forge.pkcs12.toPkcs12Asn1(keys.privateKey, [cert], pwd,
          {generateLocalKeyId: true, 
           friendlyName: 'solid-cert',
           algorithm: '3des'
           });

     var p12Der = forge.asn1.toDer(p12Asn1).getBytes();
     var p12B64 = forge.util.encode64(p12Der);

     return {pem: pemCert, pkcs12B64: p12B64};
   }


   function genCSR(certName, certEmail, certOrg, certOrgUnit, certCity, certState, certCountry, webId, pwd) {
     var pki = forge.pki;

     // generate a keypair and create an X.509v3 certificate
     var keys = pki.rsa.generateKeyPair(2048);

     var csr = pki.createCertificationRequest();
     csr.publicKey = keys.publicKey;

     var attrs = [];
     if (certName && certName.length > 1) {
       attrs.push({ name: 'commonName', value: certName });
     }

     if (certCountry && certCountry.length > 1) {
        attrs.push({ name: 'countryName', value: certCountry });
     }

     if (certState && certState.length > 1) {
        attrs.push({ shortName: 'ST', value: certState });
     }

     if (certCity && certCity.length > 1) {
        attrs.push({ name: 'localityName', value: certCity });
     }
     if (certOrgUnit && certOrgUnit.length > 1) {
        attrs.push({ name: 'organizationalUnitName', value: certOrgUnit });
     }

     if (certOrg && certOrg.length > 1) {
        attrs.push({ name: 'organizationName', value: certOrg });
     } else {
        attrs.push({ name: 'organizationName', value: 'WebID' });
     }
     if (certEmail && certEmail.length > 1) {
        attrs.push({ name: 'emailAddress', value: certEmail});
     }

     csr.setSubject(attrs);

// set (optional) attributes
     csr.setAttributes([
//     { name: 'challengePassword',  value: 'password'}, 
//     { name: 'unstructuredName',  value: 'My Company, Inc.'}, 
     
       { name: 'extensionRequest',
          extensions: [
           { name: 'subjectAltName',  
              altNames: [{
               type: 6,
               value: webId
              }]
           },
           { name: 'keyUsage',  digitalSignature: true },
           { name: 'extKeyUsage', clientAuth: true}
           ]
       }
     ]);

     csr.sign(keys.privateKey, forge.md.sha512.create());

     var pemCSR = pki.certificationRequestToPem(csr);
     var pemPKey;

     if (pwd.length > 0) {
       var ekey = pki.encryptPrivateKeyInfo(pki.privateKeyToAsn1(keys.privateKey), 
                                     pwd,
                                     { algorithm: '3des',
                                       prfAlgorithm: 'sha512'
                                     });
       pemPKey = pki.encryptedPrivateKeyToPem(ekey);
     } else {
       pemPKey = pki.privateKeyToPem(keys.privateKey);
     }

     return {pem: pemCSR, pkey: pemPKey};
   }


   function handleLoadPemFile(evt) {
     var tempReader = new FileReader();

     var currentFiles = evt.target.files;

     // noinspection AnonymousFunctionJS
     tempReader.onload = function (event) {
  	// noinspection JSUnresolvedVariable
	var certBuffer = event.target.result;
	var fld = document.getElementById('cert-data');
	fld.value = ab2str(certBuffer);
     };

     tempReader.readAsArrayBuffer(currentFiles[0]);
   }

   function ab2str(buf) {
     return String.fromCharCode.apply(null, new Uint8Array(buf));
   }

   function getCertDays() {
     solid.auth.fetch('/certdays',
          { method: 'GET', 
            headers: {
              'Accept': 'text/plain; charset=utf-8'
            },
            credentials: 'include'
          })
        .then(function(response) {
          if (response.ok) {
            response.text().then((s)=> {
              var days = parseInt(s, 10);
              if (days > 0) {
                certDays = days;
              }
            })
          }
        })
   }

  function initCountries() 
  {
    var select = document.querySelector('#certModal #cert_Country');
    select.options.length = 0;
    var el = document.createElement('option');
    el.text = '';
    el.value = '';
    select.add(el);

    for(var i=0; i< COUNTRIES.length; i++) {
      var c = COUNTRIES[i];
      var el = document.createElement('option');
      el.text = c.cl;
      el.value = c.ccode;
      select.add(el);
    }

    var select = document.querySelector('#csrModal #csr_Country');
    select.options.length = 0;
    var el = document.createElement('option');
    el.text = '';
    el.value = '';
    select.add(el);

    for(var i=0; i< COUNTRIES.length; i++) {
      var c = COUNTRIES[i];
      var el = document.createElement('option');
      el.text = c.cl;
      el.value = c.ccode;
      select.add(el);
    }
  }

  function DOM_qShow(sel)
  {
    document.querySelector(sel).classList.remove('hidden');
  }
  function DOM_qHide(sel)
  {
    document.querySelector(sel).classList.add('hidden');
  }
  function DOM_qSel(sel)
  {
    return document.querySelector(sel); 
  }


  class UpdateDelegate 
  {

    showCertKeys(gen) 
    {
      var self = this;
      var tbody = DOM_qSel('#cert-key-dlg #cert-key-tbl tbody');
      var keys = gen.delegate_keys;

      tbody.innerHTML = '';

      function mk_subitem(name, val)
      {
        if (val) {
          return '<tr>'
               +' <td style="padding-right:10px; text-align:right;" valign="top">'
               + name
               +' </td>'
               +'<td style="word-break: break-word;">'+val+'</td>'
               +'</tr>';
        } else {
          return '';
        }
      }

      function mk_row(k)
      {
        if (!k)
          return '';

        var label = k.pkey + (k.key_label?' / '+k.key_label : '');

        var s = '<td><table class="certkeys_item"><tbody>';

        s+= `<tr><td style="width:20px">
              <input type="checkbox" id="chk">
             </td><td class="key_name">${label}</td></tr>`;

        s+= `<tr><td></td><td class="dtext">
               <input title="Show details" height="12" width="12" src="common/css/plus.png" id="det_btn" type="image">
               Details
             </td></tr>`;

        s += '<tr> <td></td> <td> <table class="dettable hidden"> <tbody>';

        s += mk_subitem('Label:', k.key_label);
        s += mk_subitem('Title:', k.key_title);
        s += mk_subitem('Created:', k.key_created);
        s += mk_subitem('Modulus:', k.mod);
        s += mk_subitem('Exponent:', k.exp);

        s += '</tbody> </table> </td> </tr>';

        s +=' </tbody> </table> </td>'

        return s;
      }

     
      for(var i=0; i < keys.length; i++) {
        var s = mk_row(keys[i]);
        if (s) {
          var r = tbody.insertRow(-1);
          r.innerHTML = s;

          if (keys[i].mod === gen.delegate_key_mod)
            r.querySelector('#chk').checked = true;

          r.querySelector('#chk').onclick = (ev) => {
            var chk = ev.target;
            if (chk.checked) {
              console.log(ev);
              var lst = tbody.querySelectorAll('#chk');
              for (var i=0; i < lst.length; i++) {
                if (lst[i] !== chk)
                  lst[i].checked = false;
              }
            }
          };
          
          r.querySelector('#det_btn').onclick = (ev) => {
            var btn = ev.target;
            var item = btn.closest('table.certkeys_item');
            var tbl = item.querySelector('table.dettable');
            tbl.classList.toggle('hidden');
            if (tbl.classList.contains('hidden'))
              btn.src = "common/css/plus.png"
            else
              btn.src = "common/css/minus.png"
          };
        }
      }

      $('#cert-key-dlg').modal('show');
      document.querySelector('#cert-key-dlg #btn-ok')
        .onclick = () => {
        
          var lst = tbody.querySelectorAll('#chk');
          for (var i=0; i < lst.length; i++) {
            if (lst[i].checked) {
              var k = keys[i];
              gen.delegate_key_exp = k.exp;
              gen.delegate_key_mod = k.mod;
              gen.delegate_key_label = k.pkey + (k.key_label?' / '+k.key_label : '');
              this.setDelegatorText(gen);
              $('#cert-key-dlg').modal('hide');
              break;
            }
          }
        };
    }

    async fetchDelegate(gen, webid) 
    {
      var done_ok = false;
      DOM_qShow('#certModal #delegate_wait');
      var uri = DOM_qSel('#certModal #delegate_uri').value;
      try {
        var rc = await (new YouID_Loader()).verify_ID(uri);
        if (rc.success) {
          var s;

          gen.delegate_profile = rc.profile;
          gen.delegate_uri = rc.youid.id;
        
          var rkeys = await (new YouID_Loader()).getCertKeys(gen.delegate_profile, gen.delegate_uri);
          if (rkeys.err) {
            alert('Could not get certificate Keys from profile');
            gen.delegate_keys = [];
          } else {
            gen.delegate_keys = rkeys.keys;
          }

          if (gen.delegate_keys.length===0) {
            gen.delegate_keys.push({'pkey':'key', 'mod': rc.youid.mod, 'exp': rc.youid.exp});
          }

          var k = gen.delegate_keys[0];
          gen.delegate_key_exp = k.exp;
          gen.delegate_key_mod = k.mod;
          gen.delegate_key_label = k.pkey + (k.key_label?' / '+k.key_label : '');

          gen.delegator_webid = webid;

          this.setDelegateText(gen);
          this.setDelegatorText(gen);
        }
      }
      catch (e) {
        alert(e);
      }
      finally {
        DOM_qHide('#certModal #delegate_wait');
      }
    }

    async setDelegateText(gen) 
    {
      var s = '';
      if (gen.delegate_uri && gen.delegator_webid) {
         s = '@prefix oplcert: <http://www.openlinksw.com/schemas/cert#> . \n\n';
         // delegate  -> delegator
         s += `INSERT { \n`;
         s += `<${gen.delegate_uri}> \n`;
         s += `            oplcert:onBehalfOf <${gen.delegator_webid}> .\n`;
         s += ` }\n`;
      }

      DOM_qSel('#certModal #delegate-text').value = s;
    }

    async setDelegatorText(gen) 
    {
      var s = '';
      if (gen.delegator_webid && gen.delegate_uri) {
        s = '@prefix acl: <http://www.w3.org/ns/auth/acl#> . \n' +
          '@prefix xsd: <http://www.w3.org/2001/XMLSchema#> . \n' +
          '@prefix cert: <http://www.w3.org/ns/auth/cert#> . \n\n';

        s += `INSERT { \n`;
        s += `<${gen.delegator_webid}> \n`;
        s += `      acl:delegates <${gen.delegate_uri}> . \n`;

        s += `<${gen.delegate_uri}> \n`;
        s += `   cert:key [ \n`;
        s += `             a cert:RSAPublicKey;\n`;
        s += `             cert:exponent  "${gen.delegate_key_exp}"^^xsd:int;\n`;
        s += `             cert:modulus   "${gen.delegate_key_mod}"^^xsd:hexBinary\n`;
        s += `            ] .\n`;
        s += ` }\n`;
      }

      DOM_qSel('#certModal #delegator-text').value = s;

      var btn = DOM_qSel('#certModal #btn-delegate_cert_key');
      if (gen.delegate_uri)
        btn.childNodes[0].nodeValue = gen.delegate_key_label;
      else
        btn.childNodes[0].nodeValue = 'Certificate Key';
    }



    async uploadDelegate(gen, webid, certData) 
    {
      if (!gen.delegate_uri) {
        alert('Delegate profile must be fetched at first');
        return;
      }
      var url = new URL(gen.delegate_uri);

      if (url.protocol === 'http:')
        url.protocol = 'https:';

      url.hash = '';

      var query = DOM_qSel('#certModal #delegate-text').value;
      if (query.length < 1) {
        alert('Delegate query is empty');
        return;
      }

      var options = {
        method: 'PATCH',
        headers: {
          'Content-Type': 'application/sparql-update; charset=utf-8'
        },
        credentials: 'include',
        body: query
      }

      DOM_qSel('#certModal #u_msg').innerText = 'Updating Delegate profile';
      DOM_qShow('#certModal #u_wait');
    
      try {
        var resp = await solid.auth.fetch(url.href, options);
        if (!resp.ok) {
          alert('Could not update Delegate profile HTTP=' + resp.status + '  ' + resp.statusText)
        } else {
          alert('Delegate relations were uploaded');
        }
      } catch (e) {
        alert('Could not update Delegate profile ' + e);
        console.log(e);
      } finally {
        DOM_qSel('#certModal #u_msg').innerText = '';
        DOM_qHide('#certModal #u_wait');
      }
    }

    async uploadDelegator(gen, webid, certData) 
    {
      var url = new URL(webid);
      url.hash = '';

      var query = DOM_qSel('#certModal #delegator-text').value;
      if (query.length < 1) {
        alert('Delegator query is empty');
        return;
      }

      var options = {
        method: 'PATCH',
        headers: {
          'Content-Type': 'application/sparql-update; charset=utf-8'
        },
        credentials: 'include',
        body: query
      }

      DOM_qSel('#certModal #u_msg').innerText = 'Updating Delegator profile';
      DOM_qShow('#certModal #u_wait');
      try {
        var resp = await solid.auth.fetch(url.href, options);
        if (!resp.ok) {
          alert('Could not update Delegator profile HTTP=' + resp.status + '  ' + resp.statusText)
        } else {
          alert('Delegator relations were uploaded');
        }
      } catch (e) {
        alert('Could not update Delegator profile ' + e);
        console.log(e);
      } finally {
        DOM_qSel('#certModal #u_msg').innerText = '';
        DOM_qHide('#certModal #u_wait');
      }
    }
  }


  initCertGen();

})();

</script>
</html>
