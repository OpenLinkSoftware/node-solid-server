<form id="tls" method="post" action="/login/tls">
  <div class="form-group">

    <button type="submit" class="btn btn-primary" id="login-tls">
      With Certificate (WebId+Delegate-TLS)
    </button>

    {{> auth/auth-hidden-fields}}
  </div>
</form>

<script type="text/javascript">
  const button = document.getElementById('login-tls')
  button.addEventListener('click', function(event) {
    const client_id = document.querySelector('#tls #client_id')
    const scope = document.querySelector('#tls #scope')
    const request = document.querySelector('#tls #request')

    if (client_id && scope && request 
        && client_id.value.length == 0
        && scope.value.length == 0
        && request.value.length == 0) {

      event.preventDefault()
      fetch('/login/tls',
        { method: 'POST', credentials: 'include'})
       .then(function(response) {
          const webId = response.headers.get('user')
          const idp = new URL(webId).origin
          const session = { authType: 'WebID-TLS', webId, idp }
          const authClientNamespace = 'solid-auth-client'
          let authClientStore
          try {
            authClientStore = JSON.parse(localStorage.getItem(authClientNamespace) || '{}')
          } catch (err) {
            authClientStore = {}
          }
          authClientStore.session = session
          localStorage.setItem(authClientNamespace, JSON.stringify(authClientStore))

          response.text().then(function(text) {
            try {
              const url = new URL(text);
              window.location.href = url.href;
            } catch(err) {
            }
          })
       })
    }
  })
</script>
